<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üöÜ Train Traffic Control System - MVP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #3b2667 0%, #bc78ec 100%); min-height: 100vh; }
    .card { box-shadow: 0 8px 24px rgba(0,0,0,0.15); border: none; }
    .card-header { font-weight: 600; background: #fff; }
    .metric { font-size: 1.6rem; font-weight: 700; }
    .metric-label { color: #6c757d; font-size: .9rem; }
    .status-free { color: #198754; font-weight: 600; }
    .status-occupied { color: #dc3545; font-weight: 600; }
    .badge-priority-1 { background: #dc3545; }
    .badge-priority-2 { background: #fd7e14; }
    .badge-priority-3 { background: #0d6efd; }
    .topbar { color: #fff; }
    .small { font-size: .875rem; }
    .network-node { width: 120px; text-align: center; margin: 0 10px; padding: 6px 8px; border-radius: 8px; background: #f8f9fa; }
    .node-station { border: 2px solid #0d6efd; }
    .node-free { border: 2px solid #198754; }
    .node-occupied { border: 2px solid #dc3545; }
    .scroll-area { max-height: 320px; overflow-y: auto; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3 topbar">
      <h3 class="m-0">üöÜ Real-Time Delhi Train Control System</h3>
      <div>
        <span class="me-2">Status: <span id="simStatus" class="fw-bold">Idle</span></span>
        <span>Progress: <span id="simProgress">0</span>%</span>
        <small class="ms-2" id="lastUpdate">Last Update: --:--:--</small>
      </div>
    </div>
    
    <!-- Delhi Weather & Alerts Bar -->
    <div class="row mb-3">
      <div class="col">
        <div class="alert alert-info mb-0 py-2" id="weatherAlert">
          <strong>üå§Ô∏è Weather:</strong> <span id="weatherInfo">Loading...</span>
          <strong class="ms-3">‚ö†Ô∏è System Alerts:</strong> <span id="systemAlerts">0 active</span>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-3">
        <div class="card">
          <div class="card-header">Control Panel</div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button id="btnStart" class="btn btn-primary">Run Simulation</button>
              <button id="btnSafety" class="btn btn-outline-success">Validate Safety</button>
              <button id="btnStop" class="btn btn-outline-danger">Stop</button>
              <button id="btnRefresh" class="btn btn-outline-secondary">Refresh Metrics</button>
            </div>
            <hr/>
            <div class="small text-muted">This MVP enforces block occupancy and headway rules and validates for head-on collisions on single-track blocks.</div>
          </div>
        </div>
        <div class="card mt-3">
          <div class="card-header">Performance Metrics</div>
          <div class="card-body">
            <div class="row text-center g-2">
              <div class="col-6">
                <div class="metric" id="mThroughput">-</div>
                <div class="metric-label">Throughput (trains/hr)</div>
              </div>
              <div class="col-6">
                <div class="metric" id="mAvgDelay">-</div>
                <div class="metric-label">Avg Delay (min)</div>
              </div>
              <div class="col-6">
                <div class="metric" id="mUtilization">-</div>
                <div class="metric-label">Utilization (%)</div>
              </div>
              <div class="col-6">
                <div class="metric" id="mSafety">-</div>
                <div class="metric-label">Safety Score</div>
              </div>
              <div class="col-6">
                <div class="metric" id="mOnTime">-</div>
                <div class="metric-label">On-Time (%)</div>
              </div>
              <div class="col-6">
                <div class="metric" id="mActive">-</div>
                <div class="metric-label">Active Trains</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Route Recommendations Card -->
        <div class="card mt-3">
          <div class="card-header">üöè Route Recommendations</div>
          <div class="card-body">
            <div id="routeRecommendations" class="small">
              <div class="text-muted">No active recommendations</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-9">
        <div class="card mb-3">
          <div class="card-header">Network View</div>
          <div class="card-body">
            <div id="network" class="d-flex align-items-center flex-wrap"></div>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Event Log</div>
              <div class="card-body scroll-area">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Event</th>
                      <th>Train</th>
                      <th>Block</th>
                      <th>Message</th>
                    </tr>
                  </thead>
                  <tbody id="eventTable"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header">Train Schedules</div>
              <div class="card-body scroll-area">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Train</th>
                      <th>Type</th>
                      <th>Priority</th>
                      <th>Status</th>
                      <th>Departure</th>
                      <th>Delay</th>
                    </tr>
                  </thead>
                  <tbody id="scheduleTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function renderNetwork() {
      const res = await fetch('/api/visualization/network_graph');
      const data = await res.json();
      const div = document.getElementById('network');
      div.innerHTML = '';
      data.nodes.forEach(n => {
        const el = document.createElement('div');
        const occ = (n.status || 'FREE').startsWith('OCCUPIED');
        el.className = `network-node ${n.station ? 'node-station' : ''} ${occ ? 'node-occupied' : 'node-free'}`;
        el.innerHTML = `<div class="fw-bold">${n.id}</div><div class="small">${n.label.split('\n')[1] || ''}</div><div class="small ${occ ? 'status-occupied' : 'status-free'}">${occ ? n.status : 'FREE'}</div>`;
        div.appendChild(el);
      });
    }

    async function refreshRealtime() {
      const res = await fetch('/api/realtime/status');
      const data = await res.json();
      if (data) {
        const status = data.stopped ? 'Stopped' : (data.running ? 'Running' : 'Idle');
        document.getElementById('simStatus').textContent = status;
        document.getElementById('simProgress').textContent = data.progress || 0;
        document.getElementById('lastUpdate').textContent = `Last Update: ${data.timestamp || '--:--:--'}`;

        // Update weather and alerts
        if (data.weather_conditions) {
          const weather = data.weather_conditions;
          document.getElementById('weatherInfo').textContent = 
            `${weather.condition} (${weather.temperature}¬∞C) - ${weather.advisory}`;
        }
        
        const alertCount = (data.delhi_alerts || []).length;
        document.getElementById('systemAlerts').textContent = `${alertCount} active`;
        
        // Update metrics in real-time
        if (data.kpis) {
          document.getElementById('mThroughput').textContent = data.kpis.throughput || '-';
          document.getElementById('mAvgDelay').textContent = data.kpis.avg_delay || '-';
          document.getElementById('mSafety').textContent = data.kpis.safety_score || '-';
          document.getElementById('mOnTime').textContent = data.kpis.on_time_performance || '-';
          document.getElementById('mActive').textContent = data.kpis.active_trains || '-';
        }
        
        // Update route recommendations
        updateRouteRecommendations(data.route_recommendations || []);

        // Update events
        const et = document.getElementById('eventTable');
        et.innerHTML = '';
        (data.recent_events || []).slice().reverse().forEach(e => {
          const tr = document.createElement('tr');
          const severityClass = e.severity === 'CRITICAL' ? 'text-danger' : 
                               e.severity === 'WARNING' ? 'text-warning' : '';
          tr.innerHTML = `<td>${e.time_str}</td><td><span class="${severityClass}">${e.event_type}</span></td><td>${e.train_id || ''}</td><td>${e.block_id || ''}</td><td class="small">${e.message}</td>`;
          et.appendChild(tr);
        });
      }
      renderNetwork();
    }
    
    function updateRouteRecommendations(recommendations) {
      const container = document.getElementById('routeRecommendations');
      
      if (!recommendations || recommendations.length === 0) {
        container.innerHTML = '<div class="text-muted">No active recommendations</div>';
        return;
      }
      
      let html = '';
      recommendations.forEach(rec => {
        const efficiencyBadge = rec.efficiency === 'HIGH' ? 'success' : 
                               rec.efficiency === 'MEDIUM' ? 'warning' : 'danger';
        
        html += `
          <div class="mb-2 p-2 border rounded">
            <div class="d-flex justify-content-between align-items-center">
              <strong>Route: ${rec.route.join(' ‚Üí ')}</strong>
              <span class="badge bg-${efficiencyBadge}">${rec.efficiency}</span>
            </div>
            <div class="text-muted">${rec.alternative_reason}</div>
            <div class="small">
              <strong>Time:</strong> ${rec.estimated_time_minutes} min | 
              <strong>Occupied:</strong> ${rec.occupied_blocks.length} blocks
            </div>
            <div class="small mt-1">
              <em>${rec.recommendation}</em>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    async function refreshMetrics() {
      const res = await fetch('/api/performance/metrics');
      if (!res.ok) return;
      const m = await res.json();
      document.getElementById('mThroughput').textContent = m.efficiency.throughput;
      document.getElementById('mAvgDelay').textContent = m.punctuality.avg_delay;
      document.getElementById('mUtilization').textContent = m.efficiency.section_utilization;
      document.getElementById('mSafety').textContent = m.safety.safety_score;

      const schedRes = await fetch('/api/performance/train_schedules');
      const schedData = await schedRes.json();
      const st = document.getElementById('scheduleTable');
      st.innerHTML = '';
      (schedData.schedules || []).forEach(s => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${s.train_id}</td><td><span class="badge text-bg-secondary">${s.type}</span></td><td><span class="badge badge-priority-${s.priority}">${s.priority}</span></td><td>${s.status}</td><td>${s.departure}</td><td>${s.delay}</td>`;
        st.appendChild(tr);
      });
    }

    async function validateSafety() {
      const res = await fetch('/api/safety/validate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      const data = await res.json();
      if (data.is_safe) {
        alert('Safety Check: PASS - No collision risks detected');
      } else {
        const details = (data.violations || []).map(v => `- [${v.severity}] ${v.message}`).join('\n');
        alert('Safety Check: FAIL\n' + details);
      }
    }

    document.getElementById('btnStart').addEventListener('click', async () => {
      await fetch('/api/control/start_simulation', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
      // Poll realtime status during run
      const interval = setInterval(async () => {
        const res = await fetch('/api/realtime/status');
        const data = await res.json();
        document.getElementById('simStatus').textContent = data.running ? 'Running' : 'Idle';
        document.getElementById('simProgress').textContent = data.progress || 0;
        await refreshRealtime();
        if (!data.running) { clearInterval(interval); await refreshMetrics(); }
      }, 1200);
    });
    document.getElementById('btnStop').addEventListener('click', async () => {
      const btn = document.getElementById('btnStop');
      btn.disabled = true;
      btn.textContent = 'Stopping...';
      
      try {
        const res = await fetch('/api/control/stop_simulation', { method: 'POST' });
        const result = await res.json();
        
        if (result.success) {
          alert(`‚úÖ ${result.message} at ${result.timestamp}`);
        } else {
          alert(`‚ùå ${result.message}`);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Stop';
        await refreshRealtime();
      }
    });
    
    document.getElementById('btnRefresh').addEventListener('click', async () => {
      const btn = document.getElementById('btnRefresh');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Refreshing...';
      
      try {
        const res = await fetch('/api/control/refresh_metrics', { method: 'POST' });
        const result = await res.json();
        
        if (result.success) {
          // Show success feedback
          btn.innerHTML = '‚úÖ Refresh Done!';
          btn.className = 'btn btn-success';
          
          // Display detailed update info
          const updateInfo = result.updated_data;
          const message = `Refresh completed at ${result.timestamp}\n\n` +
                         `üìä Updated: ${updateInfo.station_count} stations, ${updateInfo.live_trains} trains\n` +
                         `üö® Alerts: ${updateInfo.system_alerts}\n` +
                         `üõ§Ô∏è Recommendations: ${updateInfo.recommendations_count}`;
          
          setTimeout(() => alert(message), 200);
          
          // Refresh UI data
          await refreshMetrics();
          await refreshRealtime();
          
          // Reset button after delay
          setTimeout(() => {
            btn.className = 'btn btn-outline-secondary';
            btn.textContent = originalText;
          }, 2000);
        } else {
          throw new Error(result.error || 'Refresh failed');
        }
      } catch (error) {
        btn.innerHTML = '‚ùå Refresh Failed';
        btn.className = 'btn btn-danger';
        alert(`Refresh failed: ${error.message}`);
        
        setTimeout(() => {
          btn.className = 'btn btn-outline-secondary';
          btn.textContent = originalText;
        }, 2000);
      } finally {
        btn.disabled = false;
      }
    });
    
    document.getElementById('btnSafety').addEventListener('click', validateSafety);

    // Initial render
    renderNetwork();
    setInterval(refreshRealtime, 3000);
  </script>
</body>
</html>

